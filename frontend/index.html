<!DOCTYPE html>
<html>
<head>
<title>Docs Collab</title>
<style>
  .editor-container {
    width: 1000px;
    height: 500px;
    border: 1px solid #ccc;
    padding: 10px;
    overflow: auto; /* Allows scrolling if content overflows */
    direction: ltr;
    unicode-bidi: plaintext;
  }
</style>

<script>
  let ws;
  let lastSentContent = '';
  let debounceTimer = null;

  window.addEventListener("DOMContentLoaded", () => {
    window.join = function () {
      const user = document.getElementById("username").value.trim();
      if (!user) return;

      let protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${location.host}/ws`);

      ws.onopen = () => {
        ws.send(user); // send username
        // Initialize with current content
        const div = document.querySelector(".editor-container");
        lastSentContent = div.innerHTML;
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);

          // Handle system messages
          if (data.type === "system") {
              document.getElementById("status").textContent = data.message;
              setTimeout(() => {
                  document.getElementById("status").textContent = '';
              }, 3000); // Clear after 3 seconds
              return;
          } 
        } catch (e) {
          // Existing content update handling
          const div = document.querySelector(".editor-container");
          // Only update if the incoming content is different
          if (div.innerHTML !== event.data) {
            div.innerHTML = event.data;
            lastSentContent = event.data; // Keep track of the last known content
          }
        }
      };
    }

    const elTarget = document.querySelector(".editor-container");
    const observer = new MutationObserver(handleEditorMutation);
    const objConfig = {
      childList: true,
      subtree: true,
      attributes: false,
      characterData: true
    };

    function handleEditorMutation(mutationsList) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      const div = document.querySelector(".editor-container");
      const currentContent = div.innerHTML;
      
      if (debounceTimer) clearTimeout(debounceTimer);
      
      if (currentContent !== lastSentContent) {
        debounceTimer = setTimeout(() => {
          ws.send(currentContent);
          lastSentContent = currentContent;
        }, 50);
      }
    }

    if (elTarget) {
      observer.observe(elTarget, objConfig);
    } else {
      console.error("Target element not found");
    }
  });
</script>
</head>
<body>
  <input id="username" placeholder="Your username">
    <button onclick="join()">Join</button><br><br>
  <div id="status" style="color:#666; font-style:italic; margin-bottom:10px;"></div>
  <div class="editor-container" contenteditable="true" dir="ltr">
  </div>
</body>
</html>