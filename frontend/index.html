<!DOCTYPE html>
<html>
<head>
<title>Docs Collab</title>
<style>
  .editor-container {
    width: 1000px;
    height: 500px;
    border: 1px solid #ccc;
    padding: 10px;
    overflow: auto; /* Allows scrolling if content overflows */
    direction: ltr;
    unicode-bidi: plaintext;
  }
</style>

<script>
  let ws;

  window.addEventListener("DOMContentLoaded", () => {
    window.join = function () {
      const user = document.getElementById("username").value.trim();
      if (!user) return;

      let protocol = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${location.host}/ws`);

      ws.onopen = () => {
        ws.send(user); // send username
      };

      ws.onmessage = (event) => {
         const div = document.getElementsByClassName("editor-container")[0];
         div.innerHTML = event.data;
      };
    }

    const elTarget = document.querySelector(".editor-container");
    const observer = new MutationObserver(handleEditorMutation);
    const objConfig = {
      childList: true,
      subtree: true,
      attributes: false,
      characterData: true
    };

    if (elTarget) {
      observer.observe(elTarget, objConfig);
    } else {
      console.error("Target element not found");
    }

    function handleEditorMutation(mutationsList) {
      for (const mutation of mutationsList) {
        console.log('Mutation type:', mutation.type);
        console.log('Target:', mutation.target);

        if (mutation.type == "characterData") {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(mutation.target.textContent);
          }
        }
      }
    }
  });
</script>
</head>
<body>
  <input id="username" placeholder="Your username">
    <button onclick="join()">Join</button><br><br>
  <div class="editor-container" contenteditable="true" dir="ltr">
  </div>
</body>
</html>